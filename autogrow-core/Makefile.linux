# Makefile for Linux
# AI Project Template - Test and CI Setup

.PHONY: help install install-claude install-gemini install-test-deps test test-unit test-integration test-all clean

# Default target
help:
	@echo "AI Project Template - Linux Makefile"
	@echo ""
	@echo "Available targets:"
	@echo "  install              - Install all dependencies"
	@echo "  install-claude       - Install Claude Code CLI"
	@echo "  install-gemini       - Install Gemini CLI"
	@echo "  install-test-deps    - Install test dependencies"
	@echo "  test                 - Run unit tests only"
	@echo "  test-unit            - Run unit tests"
	@echo "  test-integration     - Run integration tests (requires API keys)"
	@echo "  test-all             - Run all tests"
	@echo "  test-coverage        - Run tests with coverage report"
	@echo "  lint                 - Run code linters"
	@echo "  format               - Format code with black"
	@echo "  clean                - Clean temporary files"
	@echo "  ci-flow              - Complete CI setup and test (for CI/CD)"
	@echo "  ci-integration-flow  - Complete CI integration test (for CI/CD)"
	@echo ""
	@echo "Environment variables:"
	@echo "  GEMINI_API_KEY       - Required for Gemini integration tests"
	@echo "  ANTHROPIC_API_KEY    - Required for Claude integration tests (if using API)"
	@echo ""

# Install all dependencies
install: install-claude install-gemini install-test-deps
	@echo "‚úÖ All dependencies installed"

# Install Claude Code CLI
install-claude:
	@echo "üì¶ Installing Claude Code CLI..."
	@if command -v claude >/dev/null 2>&1; then \
		echo "‚úÖ Claude CLI already installed: $$(claude --version 2>&1 | head -1)"; \
	else \
		echo "Installing Claude CLI for Linux..."; \
		if command -v curl >/dev/null 2>&1; then \
			mkdir -p ~/.local/bin; \
			curl -fsSL https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-linux-x64.tar.gz | tar -xz -C ~/.local/bin; \
			chmod +x ~/.local/bin/claude; \
			echo "‚úÖ Claude CLI installed to ~/.local/bin/claude"; \
			echo "   Add ~/.local/bin to your PATH if needed"; \
		else \
			echo "‚ùå curl not found. Install with: sudo apt-get install curl"; \
			echo "   Or download manually from: https://code.claude.com/"; \
			exit 1; \
		fi \
	fi

# Install Gemini CLI via npm
install-gemini:
	@echo "üì¶ Installing Gemini CLI..."
	@if command -v gemini >/dev/null 2>&1; then \
		echo "‚úÖ Gemini CLI already installed: $$(gemini --version 2>&1 | head -1)"; \
	else \
		if command -v npm >/dev/null 2>&1; then \
			npm install -g @google/generative-ai-cli; \
			echo "‚úÖ Gemini CLI installed successfully"; \
		else \
			echo "‚ùå npm not found. Install Node.js:"; \
			echo "   curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -"; \
			echo "   sudo apt-get install -y nodejs"; \
			exit 1; \
		fi \
	fi

# Install Python test dependencies
install-test-deps:
	@echo "üì¶ Installing Python dependencies..."
	@if command -v python3 >/dev/null 2>&1; then \
		python3 -m pip install --upgrade pip; \
		python3 -m pip install -r src/requirements.txt; \
		python3 -m pip install -r tests/requirements.txt; \
		echo "‚úÖ Dependencies installed"; \
	else \
		echo "‚ùå Python 3 not found. Install with: sudo apt-get install python3 python3-pip"; \
		exit 1; \
	fi

# Run unit tests only (no API calls)
test: test-unit

test-unit:
	@echo "üß™ Running unit tests..."
	@cd tests && python3 -m pytest unit/ -v -m "not integration" --tb=short --ignore=../src/claude-agent/tests --ignore=../src/gemini-agent/tests

# Run integration tests (requires API keys)
test-integration:
	@echo "üß™ Running integration tests..."
	@if [ -z "$$GEMINI_API_KEY" ]; then \
		echo "‚ö†Ô∏è  GEMINI_API_KEY not set - Gemini integration tests will be skipped"; \
	fi
	@cd tests && python3 -m pytest integration/ -v -m "integration" --tb=short

# Run all tests
test-all:
	@echo "üß™ Running all tests..."
	@cd tests && python3 -m pytest -v --tb=short

# Run tests with coverage (unit tests only - no AI API calls)
test-coverage:
	@echo "üìä Running tests with coverage (unit tests only)..."
	@cd tests && python3 -m pytest \
		--cov=../src/gemini-agent \
		--cov=../src/claude-agent \
		--cov-report=html:htmlcov \
		--cov-report=xml:htmlcov/coverage.xml \
		--cov-report=term \
		-m "not integration" \
		-v

# Run linters
lint:
	@echo "üîç Running linters..."
	@python3 -m pylint src/gemini-agent/gemini_agent.py || true
	@python3 -m pylint src/claude-agent/claude_cli_agent.py || true
	@python3 -m flake8 src/ tests/ || true
	@echo "‚úÖ Linting complete"

# Format code
format:
	@echo "‚ú® Formatting code..."
	@python3 -m black src/ tests/
	@echo "‚úÖ Code formatted"

# Clean temporary files
clean:
	@echo "üßπ Cleaning temporary files..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".coverage" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@rm -rf src/*/output 2>/dev/null || true
	@echo "‚úÖ Cleaned"

# Verify installation
verify:
	@echo "üîç Verifying installation..."
	@echo ""
	@echo "Python:"
	@python3 --version || echo "‚ùå Python 3 not found"
	@echo ""
	@echo "Claude CLI:"
	@claude --version 2>&1 | head -1 || echo "‚ùå Claude CLI not found"
	@echo ""
	@echo "Gemini CLI:"
	@gemini --version 2>&1 | head -1 || echo "‚ùå Gemini CLI not found"
	@echo ""
	@echo "pip packages:"
	@python3 -m pip list | grep -E "pytest|anthropic|google" || echo "‚ö†Ô∏è  Some packages may be missing"
	@echo ""
	@echo "Environment variables:"
	@if [ -n "$$GEMINI_API_KEY" ]; then echo "‚úÖ GEMINI_API_KEY is set"; else echo "‚ö†Ô∏è  GEMINI_API_KEY not set"; fi
	@if [ -n "$$ANTHROPIC_API_KEY" ]; then echo "‚úÖ ANTHROPIC_API_KEY is set"; else echo "‚ö†Ô∏è  ANTHROPIC_API_KEY not set"; fi

# Quick test (fast unit tests only)
quick-test:
	@echo "‚ö° Running quick tests..."
	@cd tests && python3 -m pytest unit/ -v -m "not slow and not integration" --tb=line

# CI target (for GitHub Actions)
ci: install-test-deps test-unit
	@echo "‚úÖ CI tests passed"

# CI flow - complete CI setup and test (skip CLI installs for unit tests)
ci-flow: install-test-deps test-unit
	@echo "‚úÖ CI flow completed successfully"

# CI integration flow - setup and run integration tests
ci-integration-flow: install-test-deps install-gemini install-claude verify test-integration
	@echo "‚úÖ CI integration flow completed successfully"

# Install system dependencies (Ubuntu/Debian)
install-system-deps:
	@echo "üì¶ Installing system dependencies..."
	@if command -v apt-get >/dev/null 2>&1; then \
		sudo apt-get update; \
		sudo apt-get install -y python3 python3-pip curl nodejs npm; \
		echo "‚úÖ System dependencies installed"; \
	else \
		echo "‚ö†Ô∏è  apt-get not found. Please install dependencies manually."; \
	fi
