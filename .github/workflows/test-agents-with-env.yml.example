# Example: Test AI Agents Workflow with Environment Variables
# This is an example showing how to use centralized path configuration
# To use: rename to test-agents.yml (backup the original first)

name: Test AI Agents

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'seedgpt-core/src/gemini-agent/**'
      - 'seedgpt-core/src/claude-agent/**'
      - 'seedgpt-core/tests/**'
      - 'seedgpt-core/Makefile*'
      - '.github/workflows/test-agents.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'seedgpt-core/src/gemini-agent/**'
      - 'seedgpt-core/src/claude-agent/**'
      - 'seedgpt-core/tests/**'
      - 'seedgpt-core/Makefile*'
  workflow_dispatch:
    inputs:
      run_integration_tests:
        description: 'Run integration tests (requires API keys)'
        required: false
        type: boolean
        default: false

# Centralized path configuration
env:
  # Core paths
  CORE_DIR: seedgpt-core
  SRC_DIR: seedgpt-core/src
  TESTS_DIR: seedgpt-core/tests
  
  # Key files
  REQUIREMENTS_FILE: seedgpt-core/src/requirements.txt
  
  # Test paths
  TESTS_CACHE: seedgpt-core/tests/.pytest_cache
  COVERAGE_DIR: seedgpt-core/tests/htmlcov
  COVERAGE_XML: seedgpt-core/tests/htmlcov/coverage.xml
  
  # Agent paths
  CLAUDE_AGENT_DIR: seedgpt-core/src/claude-agent
  GEMINI_AGENT_DIR: seedgpt-core/src/gemini-agent
  CLAUDE_SCRIPTS: seedgpt-core/src/claude-agent/scripts
  GEMINI_SCRIPTS: seedgpt-core/src/gemini-agent/scripts

jobs:
  test-unit:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Display OS and Python info
        run: |
          echo "OS: ${{ matrix.os }}"
          echo "Python: ${{ matrix.python-version }}"
          python --version
          cd ${{ env.CORE_DIR }} && make show-os
      
      - name: Run CI flow
        run: |
          # Run tests from core directory
          cd ${{ env.CORE_DIR }}
          make ci-flow
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: ${{ env.TESTS_CACHE }}
          retention-days: 7

  test-integration:
    name: Integration Tests
    runs-on: ${{ matrix.os }}
    if: github.event.inputs.run_integration_tests == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Set up Node.js (for Gemini CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run CI integration flow
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd ${{ env.CORE_DIR }}
          make ci-integration-flow
        continue-on-error: true
      
      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ matrix.os }}
          path: ${{ env.TESTS_CACHE }}
          retention-days: 7

  test-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies and run coverage
        run: |
          cd ${{ env.CORE_DIR }}
          make install-test-deps
          make test-coverage
      
      - name: Verify coverage file exists
        run: |
          if [ -f "${{ env.COVERAGE_XML }}" ]; then
            echo "✅ Coverage XML file generated successfully"
            ls -lh ${{ env.COVERAGE_XML }}
          else
            echo "⚠️ Coverage XML file not found"
            echo "Contents of tests directory:"
            ls -la ${{ env.TESTS_DIR }} || true
            echo "Contents of coverage directory:"
            ls -la ${{ env.COVERAGE_DIR }} || true
          fi
      
      - name: Upload coverage to Codecov
        if: hashFiles(env.COVERAGE_XML) != ''
        uses: codecov/codecov-action@v4
        with:
          files: ${{ env.COVERAGE_XML }}
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ env.COVERAGE_DIR }}
          retention-days: 30
          if-no-files-found: warn

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Run code quality checks
        run: |
          cd ${{ env.CORE_DIR }}
          make install-test-deps
          make lint
          make format
          git diff --exit-code || (echo "Code needs formatting. Run 'make format'" && exit 1)
        continue-on-error: true

  test-scripts:
    name: Test Bash Scripts
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: |
          chmod +x ${{ env.GEMINI_SCRIPTS }}/*.sh
          chmod +x ${{ env.CLAUDE_SCRIPTS }}/*.sh
      
      - name: Test script syntax
        run: |
          for script in ${{ env.GEMINI_SCRIPTS }}/*.sh; do
            echo "Checking $script"
            bash -n "$script"
          done
          for script in ${{ env.CLAUDE_SCRIPTS }}/*.sh; do
            echo "Checking $script"
            bash -n "$script"
          done
      
      - name: Test help commands
        run: |
          ${{ env.GEMINI_SCRIPTS }}/agent_runner.sh --help || true
          ${{ env.CLAUDE_SCRIPTS }}/agent_runner_cli.sh --help || true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-unit, lint, test-scripts]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.test-unit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Script Tests: ${{ needs.test-scripts.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-unit.result }}" != "success" ]; then
            echo "❌ Unit tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ All required tests passed" >> $GITHUB_STEP_SUMMARY
          fi
